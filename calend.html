<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shared Calendar — Live Share Ready</title>
  <meta name="description" content="A single-file calendar with optional live sharing via Firebase (paste your config). Falls back to local-only if not enabled." />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; script-src 'self' 'unsafe-inline' https://www.gstatic.com; connect-src 'self' https://firestore.googleapis.com; object-src 'none'; base-uri 'none'">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0d12; --panel:#0f131a; --panel-2:#11141b; --text:#e9edf1; --muted:#a7b0bb; --brand:#6aa7ff; --brand2:#7ef0d3; --radius:16px;
      --ring:0 0 0 3px rgba(106,167,255,.35); --shadow:0 10px 30px rgba(0,0,0,.35); --shadow-sm:0 4px 14px rgba(0,0,0,.25);
      --grid: clamp(14px, 2.4vw, 22px); --maxw:1100px; --cell-bg:#0d121c; --cell-border:#293043; --cell-hover:#162034;
      --avail:#2f8f5b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--text)}
    a{color:var(--text); text-decoration:none}
    .container{max-width:var(--maxw); margin-inline:auto; padding:0 var(--grid)}
    header{position:sticky; top:0; z-index:10; backdrop-filter:blur(10px); background:linear-gradient(180deg, rgba(11,13,18,.78), rgba(11,13,18,.45)); border-bottom:1px solid rgba(255,255,255,.06)}
    .nav{display:flex; align-items:center; justify-content:space-between; height:70px}
    .logo{display:flex; align-items:center; gap:10px; font-weight:800}
    .logo-mark{height:28px; width:28px; border-radius:8px; background:conic-gradient(from 220deg, var(--brand), var(--brand2)); box-shadow:0 0 30px rgba(106,167,255,.35)}
    .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:9999px; border:1px solid #2a2f39; background:#0f131a; color:var(--text); font-weight:600}
    .btn.primary{background:linear-gradient(135deg, var(--brand), var(--brand2)); color:#0b0d12; border-color:transparent}
    .btn:focus{outline:none; box-shadow:var(--ring)}
    .badge{padding:6px 10px; border-radius:999px; background:#141927; border:1px solid #2a2f39; color:var(--muted); font-weight:600}

    .calendar{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow:var(--shadow-sm); overflow:hidden}
    .cal-head{display:flex; align-items:center; justify-content:space-between; padding:12px}
    .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); border-top:1px solid rgba(255,255,255,.08)}
    .dow{padding:10px; text-align:center; color:var(--muted); font-weight:600; border-right:1px solid rgba(255,255,255,.06); background:var(--panel-2)}
    .dow:last-child{border-right:0}
    .cell{min-height:110px; border-top:1px solid var(--cell-border); border-right:1px solid var(--cell-border); padding:8px; position:relative; background:var(--cell-bg); transition:background .12s ease; cursor:pointer}
    .cell:hover{background:var(--cell-hover)}
    .cell:last-child{border-right:0}
    .daynum{font-size:12px; color:var(--muted)}
    .today .daynum{color:#fff; font-weight:800}
    .other-month{opacity:.55}
    .event{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:6px; padding:6px 8px; border-radius:10px; background:#1a2030; border:1px solid rgba(255,255,255,.12); font-size:12px; line-height:1.3; cursor:pointer}
    .event small{color:var(--muted)}
    .event .label{display:flex; flex-direction:column}
    .event .actions{display:flex; gap:6px}
    .event.cancelled{opacity:.6; text-decoration:line-through}
    .chip{font-size:11px; padding:2px 6px; border:1px solid rgba(255,255,255,.12); border-radius:999px; background:#111728}
    .event .mini-btn{border:none; background:#0f131a; border:1px solid #2a2f39; border-radius:8px; padding:2px 6px; cursor:pointer; color:var(--text)}
    .event .mini-btn:focus{outline:none; box-shadow:var(--ring)}
    .available{position:absolute; top:6px; right:6px; width:10px; height:10px; background:var(--avail); border-radius:50%;}
    dialog form .row{display:flex; gap:10px; align-items:center; margin-bottom:10px}
    input, textarea{width:100%; background:#0f131a; border:1px solid #2a2f39; color:var(--text); padding:10px; border-radius:10px}
    label{color:var(--muted); font-size:13px}
    #conflictMsg{color:#ffb4b4}
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <a class="logo" href="#">
        <span class="logo-mark" aria-hidden="true"></span>
        <span>Shared Calendar</span>
      </a>
      <div class="controls">
        <span id="liveBadge" class="badge">Local only</span>
        <button class="btn" id="btnPrev">◀</button>
        <div id="monthLabel" style="min-width:220px; text-align:center; font-weight:800"></div>
        <button class="btn" id="btnNext">▶</button>
        <button class="btn primary" id="btnAdd">＋ Add activity</button>
        <button class="btn" id="btnToggleAvail">Toggle Availability</button>
      </div>
    </div>
  </header>

  <main class="container hero">
    <section class="calendar">
      <div class="cal-head">
        <div class="sub">Click a day to add an activity or mark availability. Click an activity to edit. Use ✕ on a chip to cancel/uncancel quickly.</div>
      </div>
      <div class="cal-grid" id="dow"></div>
      <div class="cal-grid" id="grid"></div>
    </section>
  </main>

  <dialog id="eventDialog">
    <form method="dialog" id="eventForm">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px 16px 0">
        <h3 style="margin:0">Activity</h3>
        <!-- Close without saving or filling anything -->
        <button class="btn" value="cancel" type="submit" formmethod="dialog">✕</button>
      </div>
      <div style="padding:16px; display:grid; gap:10px">
        <input type="hidden" id="evtId" />
        <div class="row">
          <label style="min-width:88px">Title</label>
          <input id="evtTitle" type="text" placeholder="Movie night" />
        </div>
        <div class="row">
          <label style="min-width:88px">Date</label>
          <input id="evtDate" type="date" />
        </div>
        <div class="row">
          <label style="min-width:88px">From</label>
          <input id="evtStart" type="time" value="18:00" />
          <label>To</label>
          <input id="evtEnd" type="time" value="20:00" />
        </div>
        <div class="row">
          <label style="min-width:88px">People</label>
          <input id="evtPeople" type="text" placeholder="anna, omar, li" />
        </div>
        <div class="row">
          <label style="min-width:88px">Notes</label>
          <textarea id="evtNotes" rows="2" placeholder="Bring snacks"></textarea>
        </div>
        <div class="row">
          <label style="min-width:88px">Status</label>
          <span class="chip" id="evtStatusChip">Planned</span>
        </div>
        <div class="row">
          <button class="btn primary" id="btnSave" value="save" type="submit">Save</button>
          <button class="btn" id="btnDelete" type="button">Delete</button>
        </div>
        <div class="muted" id="conflictMsg"></div>
      </div>
    </form>
  </dialog>

  <script type="module">
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const pad = (n) => String(n).padStart(2,'0');
    const toKey = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const STORAGE_KEY = 'shared-calendar-state-v1';

    function genId(){ return `e_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,7)}`; }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) throw 0;
        const s = JSON.parse(raw);
        // ensure defaults
        return {
          today: new Date(),
          cursor: s.cursor ? new Date(s.cursor) : new Date(new Date().getFullYear(), new Date().getMonth(), 1),
          events: Array.isArray(s.events)? s.events : [],
          available: s.available || {}
        };
      }catch{
        return { today:new Date(), cursor:new Date(new Date().getFullYear(), new Date().getMonth(),1), events:[], available:{} };
      }
    }
    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    let state = loadState();

    const gridEl=$('#grid'); const dowEl=$('#dow'); const monthLabel=$('#monthLabel');
    ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d=>{const div=document.createElement('div');div.className='dow';div.textContent=d;dowEl.appendChild(div);});

    let markingAvailability=false;
    $('#btnToggleAvail').addEventListener('click',()=>{
      markingAvailability=!markingAvailability;
      alert(markingAvailability?"Click days to mark yourself available":"Back to adding activities");
    });

    function render(){
      monthLabel.textContent=state.cursor.toLocaleString(undefined,{month:'long',year:'numeric'});
      gridEl.innerHTML='';
      const first=new Date(state.cursor.getFullYear(),state.cursor.getMonth(),1);
      const start=new Date(first);
      let day=(first.getDay()+6)%7; // Monday-first
      start.setDate(first.getDate()-day);

      for(let i=0;i<42;i++){
        const d=new Date(start);d.setDate(start.getDate()+i);
        const k=toKey(d);
        const cell=document.createElement('div');cell.className='cell';
        if(d.getMonth()!==state.cursor.getMonth())cell.classList.add('other-month');
        if(toKey(d)===toKey(state.today))cell.classList.add('today');

        const num=document.createElement('div');num.className='daynum';num.textContent=String(d.getDate());cell.appendChild(num);
        if(state.available[k]){const dot=document.createElement('div');dot.className='available';cell.appendChild(dot);}

        // events for this day
        const todays = state.events
          .filter(ev=>ev.date===k)
          .sort((a,b)=> (a.start||'00:00').localeCompare(b.start||'00:00'));

        todays.forEach(ev=>{
          const el=document.createElement('div');
          el.className='event'+(ev.cancelled?' cancelled':'');
          el.title='Click to edit';
          const label=document.createElement('div');
          label.className='label';
          const title=document.createElement('div');
          title.textContent=ev.title || '(Untitled)';
          const sub=document.createElement('small');
          const t1=ev.start||''; const t2=ev.end||'';
          sub.textContent=[t1&&t2?`${t1}–${t2}`:t1||t2, (ev.people&&ev.people.length?` · ${ev.people.join(', ')}`:'')].filter(Boolean).join('');
          label.appendChild(title); label.appendChild(sub);

          const actions=document.createElement('div'); actions.className='actions';
          const cancelBtn=document.createElement('button');
          cancelBtn.className='mini-btn'; cancelBtn.textContent='✕';
          cancelBtn.title = ev.cancelled ? 'Uncancel' : 'Cancel';
          cancelBtn.addEventListener('click',(e)=>{
            e.stopPropagation();
            ev.cancelled = !ev.cancelled;
            saveState(); render();
          });
          actions.appendChild(cancelBtn);

          el.appendChild(label); el.appendChild(actions);

          el.addEventListener('click',(e)=>{ e.stopPropagation(); openDialog(ev); });
          cell.appendChild(el);
        });

        cell.addEventListener('click',()=>{
          if(markingAvailability){
            state.available[k]=!state.available[k];
            saveState();
            render();
          }else{
            openDialog({date:k,start:'18:00',end:'20:00'});
          }
        });

        gridEl.appendChild(cell);
      }

      // persist current cursor month too
      saveState();
    }

    const dlg=$('#eventDialog'); const form=$('#eventForm');
    const idEl=$('#evtId'), titleEl=$('#evtTitle'), dateEl=$('#evtDate'), sEl=$('#evtStart'), eEl=$('#evtEnd'), pEl=$('#evtPeople'), nEl=$('#evtNotes');
    const statusChip=$('#evtStatusChip');

    function setStatusChip(cancelled){
      statusChip.textContent = cancelled ? 'Cancelled' : 'Planned';
      statusChip.style.opacity = cancelled ? '0.8' : '1';
    }

    function openDialog(evt){
      idEl.value=evt.id||'';
      titleEl.value=evt.title||'';
      dateEl.value=evt.date||toKey(new Date());
      sEl.value=evt.start||'18:00';
      eEl.value=evt.end||'20:00';
      pEl.value=(evt.people||[]).join(', ');
      nEl.value=evt.notes||'';
      setStatusChip(!!evt.cancelled);
      $('#btnDelete').style.display=evt.id?'inline-flex':'none';
      dlg.showModal();
    }

    // Save only when Save button is used; ✕ closes without saving
    form.addEventListener('submit',(e)=>{
      const action = e.submitter && e.submitter.value;
      if(action!=='save'){ return; } // allow dialog to close naturally
      e.preventDefault();

      const id = idEl.value || genId();
      const title = titleEl.value.trim() || 'Untitled';
      const date = dateEl.value || toKey(new Date());
      const start = sEl.value || '';
      const end = eEl.value || '';
      const people = pEl.value ? pEl.value.split(',').map(s=>s.trim()).filter(Boolean) : [];
      const notes = nEl.value || '';

      // if existing, keep cancelled state
      const existingIdx = state.events.findIndex(x=>x.id===id);
      const cancelled = existingIdx>=0 ? !!state.events[existingIdx].cancelled : false;

      const evt = { id, title, date, start, end, people, notes, cancelled };

      if(existingIdx>=0){ state.events[existingIdx]=evt; }
      else { state.events.push(evt); }

      saveState();
      dlg.close();
      render();
    });

    // Delete button
    $('#btnDelete').addEventListener('click',()=>{
      const id = idEl.value;
      if(!id){ dlg.close(); return; }
      state.events = state.events.filter(x=>x.id!==id);
      saveState();
      dlg.close();
      render();
    });

    // Prev/Next/Add buttons
    $('#btnPrev').addEventListener('click',()=>{state.cursor=new Date(state.cursor.getFullYear(),state.cursor.getMonth()-1,1);render();});
    $('#btnNext').addEventListener('click',()=>{state.cursor=new Date(state.cursor.getFullYear(),state.cursor.getMonth()+1,1);render();});
    $('#btnAdd').addEventListener('click',()=>openDialog({date:toKey(state.today)}));

    // Optional: clicking the status chip toggles cancelled in-place for current dialog event (no typing)
    statusChip.addEventListener('click',()=>{
      const currentId = idEl.value;
      const isEditingExisting = !!currentId;
      if(isEditingExisting){
        const idx = state.events.findIndex(x=>x.id===currentId);
        if(idx>=0){
          state.events[idx].cancelled = !state.events[idx].cancelled;
          setStatusChip(state.events[idx].cancelled);
          saveState();
          render();
        }
      }else{
        // toggles a temporary view state only; actual save applies when user clicks Save
        const nowCancelled = statusChip.textContent!=='Cancelled';
        setStatusChip(nowCancelled);
      }
    });

    // Initial render
    render();
  </script>
</body>
</html>
